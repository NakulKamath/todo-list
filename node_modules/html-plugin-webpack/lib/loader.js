'use strict';

module.exports = function (source) {
  const options = this.getOptions();
  const force = options.force || false;

  const allLoadersButThisOne = this.loaders.filter((loader) => loader.normal !== module.exports);

  if (allLoadersButThisOne.length > 0 && !force) {
    return source;
  }

  const htmlWebpackPluginLoaders = this.loaders.filter((loader) => loader.normal === module.exports);
  const lastHtmlWebpackPluginLoader = htmlWebpackPluginLoaders[htmlWebpackPluginLoaders.length - 1];
  if (this.loaders[this.loaderIndex] !== lastHtmlWebpackPluginLoader) {
    return source;
  }

  if (/\.(c|m)?js$/.test(this.resourcePath) && !force) {
    return source;
  }

  // 使用原生模板字符串和函数来替代 Lodash 的模板功能
  const templateFunction = new Function('data', `
    return \`${source}\`;
  `);

  return 'module.exports = function (templateParams) { with(templateParams) {' +
    'return (' + templateFunction + ')();' +
    '}}';
};
